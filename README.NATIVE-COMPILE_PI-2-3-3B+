******************** NATIVE COMPILE FOR THE RPI KERNEL***********************

THIS WILL UPGRADE THE KERNEL FOR USE WITH OUR ARCH LINUX IMAGE

THIS KERNEL HAS NEW DVB HEADERS. FOLLOW PROCEDURE BELOW TO SANITIZE THE
UAPI HEADERS FOR USER SPACE APPS AND INSTALL THEM AFTER COMPILING/INSTALLING
THE NEW KERNEL

*****************************************************************************

# Current kernel for the RPi 2/3/3B+ is 4.20.0-rc6

# UPDATE:

# UDL HAS ADDED A NEW DEPEND FOR THE KERNEL BUILDING. I DO NOT THINK IT AFFECTS COMPILING ON THE PI
# BUT INSTALL IT TO BE ON THE SAFE SIDE:

sudo pacman -S pigz

# CLONE REPO & COMPILE KERNEL

git clone https://gitlab.com/Dark-Sky/rpi-udl-linux.git       # Clone repo
cd rpi-udl-linux

# There is a needed header file stddef.h that has to be installed first in
# /usr/include/linux before compiling. It will be installed with the
# santized header install so lets sanitize and install all of the
# uapi (including the dvb headers) headers first before compiling the kernel
# and get it over with:

sudo cp -Rv ./sanitized-headers/include/* /usr/include/

# They have added a new gcc header depend with the 4.20 kernel that does not get picked up
# in Arch Linux for some reason so lets create a link before we compile so it will not
# error out:

sudo ln -s /usr/lib/gcc/armv7l-unknown-linux-gnueabihf/YOUR-GCC-VERSION-HERE/include/stdarg.h  /usr/include/linux/stdarg.h

# Compile the kernel

make -j4 DTC_FLAGS="-@ -H epapr" bcm2709-udl_defconfig
make -j4 DTC_FLAGS="-@ -H epapr" menuconfig             # Save and exit
make

# INSTALL KERNEL & RELATED FILES TO THE SYSTEM

sudo cp /boot/kernel7.img /boot/kernel7.img-sav   # Back up existing kernel
sudo cp arch/arm/boot/zImage /boot/kernel7.img    # Copy new kernel to /boot
sudo make INSTALL_MOD_PATH=/usr modules_install   # Installs modules

# INSTALL KERNEL BLOBS TO /BOOT

sudo cp -v arch/arm/boot/dts/bcm2709-rpi-2-b.dtb /boot
sudo cp -v arch/arm/boot/dts/bcm2710-rpi-3-b.dtb /boot/
sudo cp -v arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dtb /boot/      # New pi3b+ firm
sudo cp -v arch/arm/boot/dts/bcm2710-rpi-cm3.dtb /boot/
sudo cp -v arch/arm/boot/dts/bcm2836-rpi-2-b.dtb /boot/
sudo cp -v arch/arm/boot/dts/bcm2837-rpi-3-b.dtb /boot/
sudo cp -v arch/arm/boot/dts/overlays/*.dtb* /boot/overlays/
sudo cp -v arch/arm/boot/dts/overlays/README /boot/overlays/

# Install the updated firmware:

cd firmware
sudo make install

# DO NOT SKIP THIS. It seems they have fixed this so reverse it or it will cause problems

Edit the /boot/cmdline.txt and remove this option if you have this in the file:

dwc_otg.fiq_fsm_enable=0

sudo sync

sudo reboot
