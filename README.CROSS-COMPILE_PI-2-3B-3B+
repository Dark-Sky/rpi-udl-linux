**** CROSS COMPILE KERNEL ON A X64 SYSTEM FOR THE RPi 2/3B/3B+ RUNNING LINUX ****

THIS WILL UPGRADE THE KERNEL FOR USE WITH OUR ARCH LINUX IMAGE

THIS KERNEL HAS NEW DVB HEADERS. FOLLOW PROCEDURE BELOW TO SANITIZE THE
UAPI HEADERS FOR USER SPACE APPS AND INSTALL THEM AFTER COMPILING/INSTALLING
THE NEW KERNEL

********************************************************************************


# Current kernel for the RPi 2/3B/3B+ is 5.0.0-rc1


* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

# FIRST GET THE CROSS COMPILE TOOLCHAIN AND INSTALL IT
# (NEW CROSS COMPILE TOOL AS OF 6-27-18)
# ( THIS PART IS A 1 TIME PROCEDURE TO GET IT ON YOUR SYSTEM )

# THIS IS THE LATEST TOOLCHAIN (6-2018)

wget https://armkeil.blob.core.windows.net/developer/Files/downloads/gnu-rm/7-2018q2/gcc-arm-none-eabi-7-2018-q2-update-linux.tar.bz2

mkdir ~/opt
tar -xvf gcc-arm-none-eabi-7-2018-q2-update-linux.tar.bz2 -C ~/opt

* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

# UPDATE:

# UDL HAS ADDED A NEW DEPEND FOR THE KERNEL BUILDING. I DO NOT THINK IT AFFECTS COMPILING ON THE PI
# BUT INSTALL IT TO BE ON THE SAFE SIDE:

sudo pacman -S pigz
 
# Put your sdcard with the arch-pi OS on it you want to upgrade the kernel in your x64 computer
# and make sure the BOOT & ROOT partitions are mounted

# CLONE REPO

git clone https://bitbucket.org/dark-sky/rpi-udl-linux     # Clone repo

# SET UP ENVIORMENTAL VARIABLES (HAS TO BE DONE EACH TIME YOU COMPILE)

export PATH=~/opt/gcc-arm-none-eabi-7-2018-q2-update/bin/:${PATH}

# COMPILE KERNEL

cd rpi-udl-linux
make -j4 ARCH=arm CROSS_COMPILE=arm-none-eabi- DTC_FLAGS="-@ -H epapr" bcm2709-udl_defconfig
make -j4 ARCH=arm CROSS_COMPILE=arm-none-eabi- DTC_FLAGS="-@ -H epapr" menuconfig
make -j4 ARCH=arm CROSS_COMPILE=arm-none-eabi- DTC_FLAGS="-@ -H epapr"

# INSTALL THE KERNEL TO THE SDCARD

# BACK UP EXISTING KERNEL TO BE SAFE

sudo cp /path-to-sdcard-fat32-partition/kernel7.img /path-to-sdcard-fat32-partition/kernel7.img-sav

# COPY zImage AND RENAME TO kernel7.img TO THE SDCARDS FAT32 PARTITION

cp -v arch/arm/boot/zImage /path-to-sdcard-fat32-partition/kernel7.img    # Copy new kernel to /boot

# INSTALL THE MODULES TO THE SDCARD'S EXT4 PARTITION

sudo make ARCH=arm CROSS_COMPILE=arm-none-eabi- INSTALL_MOD_PATH=/path-to-the-sdcard-ext4-partition/usr modules_install

# INSTALL THE KERNEL RELATED FILES TO THE SDCARD'S VFAT PARTITION

cp -v arch/arm/boot/dts/bcm2709-rpi-2-b.dtb /path-to-sdcard-fat32-partition/
cp -v arch/arm/boot/dts/bcm2710-rpi-3-b.dtb /path-to-sdcard-fat32-partition/
cp -v arch/arm/boot/dts/bcm2710-rpi-3-b-plus.dtb /path-to-sdcard-fat32-partition/   # New pi3b+ firm
cp -v arch/arm/boot/dts/bcm2710-rpi-cm3.dtb /path-to-sdcard-fat32-partition/
cp -v arch/arm/boot/dts/bcm2836-rpi-2-b.dtb /path-to-sdcard-fat32-partition/
cp -v arch/arm/boot/dts/bcm2837-rpi-3-b.dtb /path-to-sdcard-fat32-partition/
cp -v arch/arm/boot/dts/overlays/*.dtb* /path-to-sdcard-fat32-partition/overlays/
cp -v arch/arm/boot/dts/overlays/README /path-to-sdcard-fat32-partition/overlays/

# INSTALL NEW SANITIZED UAPI HEADERS FOR USER SPACE APPS TO SDCARD'S ROOT PARTITION.
# (THIS WILL INCLUDE THE NEEDED DVB HEADERS)

sudo cp -Rv ./sanitized-headers/include/* /path-to-the-sdcard-ext4-partition/usr/include/

# DO NOT SKIP THIS. It seems they have fixed this so reverse it or it will cause problems

Edit the boot partition cmdline.txt and remove these 2 options if you have them in the file:

dwc_otg.fiq_enable=0 dwc_otg.fiq_fsm_enable=0

sudo sync         # Flush data still in memory to sdcard

Safely remove the sdcard and put in your Raspberry Pi and boot it up.

